テストを動かすため

IAMユーザーにssmのゲットパラメーターを付与した

環境変数の取得元がAWSからGitHubのsecretsになっているかもしれないので確認用

GitHubのSecretsからAWSのアクセスキーを入手して、AWSのSystemManagerから別のアクセスキーを入手するという無駄を排除

cloudformationの権限を付与した別のIAMユーザーに切り替えた

IAMユーザーの権限を絞って動作するか確認

cloudformationの権限を搾りすぎたため緩和

環境変数をserverless.ymlにセットしないで、GitHubのSecretsから取得できないかテスト。

serverless.ymlでは環境変数を必ずセットしなければならなかった。

様々な場所に環境変数を用意していたので可能な限り一箇所にした。

Lambdaの予約語と重なってしまったため一部環境変数名変更。

serverless.ymlにroleを指定する記述を追加

Lambdaの環境変数としてアクセスキーを設定していたのを削除。

SSMパラメーターの取得権限を間違って削除してしまったので追加。

つけ忘れたのでもう一回起動。

GitHubのSecretsと競合を起こしているか検証。

競合を解消したか確認

ルボコップ→単体テスト→ビルド→デプロイと記述を変更

再度実施。変更は不要な行の削除。

ubuntu環境に必要なライブラリをインストールさせる

ubuntuの環境が合わないのでバージョンを下げる

指定するubuntuを間違えたので修正

試しにlibsslをインストールしてみる

利用できるバージョンを指定してみる

今度はpumaのバージョンが低い可能性があるため対応。

pumaのバージョンを5に下げてみる

一旦pumaが原因でバックエンドに繋がらなくなっているか確認するためテストをコメントアウト。

githubactions側でbundle installを実行させることとした。

CDにもRubyの準備が必要になってしまったので対応

一旦rubocopをオフにする

バックエンド作り直してみる

IAMユーザーにiam:CreateRoleを付与

IAMユーザーにlogs:CreateLogGroupを付与

CloudFormationでロールバックできないので手動で削除

CloudFormationでロールバックできないので手動で削除2回目

IAMユーザーにlogs:TagResourceを付与

設定を変えず再度デプロイ

libssl.so.3の共有ライブラリレイヤーをLambdaに追加

GitHubActionsを使うとlibssl.so.3が足りないと求められる不具合を確認

BackendのCICDを通すとlibssl.so.3が無いというエラーがでる調査

CICDでRubyのバージョン変更

CDでserverless deployの環境を揃える

ubuntuのバージョンを20.04に指定

CICD上で共有ライブラリをインストールする

エラーメッセージが変わったので一旦ubuntu-latestに戻す

CICDとデプロイ先の差異を無くすため、dockerコンテナを使ってみる

tarコマンドがなかったので追加

ほかにもCICD中に必要なコマンドを追加

rubyとnodeを自身でインストールする必要があったため修正

RubyのURLを修正

gitがなかったのでインストールに追加

必要そうなものをある程度まとめてインストール
